{% extends "base.html" %}

{% block content %}
<div class="container mt-3">
    <h2>Runs</h2>
    <p>Select a program from the <a href="{{ url_for('programs')}}">installed ones</a>
        and choose action "run" to initatie a new run.<br>
        Ongoing and previous runs are shown below.</p>
    {% if prg_to_run is not none %}
    <div class="card">
        <div class="card-header" id="headingAddProgram">
            <h5>Setup and run {{program_name}}</h5>
        </div>
        <div class="card-body">
            <form action="{{ url_for('trigger_run') }}" method="post" enctype="multipart/form-data">
                <div class="row">
                    <div class="mb-3 col-md-6">
                        <label for="program_name">Program Name:</label>
                        <input type="text" name="program_name" class="form-control" disabled value="{{ program_name }}">
                        <input type="hidden" name="program_name" value="{{ program_name }}">
                    </div>
                    <div class="mb-3 col-md-6">
                        <label for="purpose">Purpose <span class="tooltip-text" data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="It can contain only alphanumeric chars and _.- Space is not allowed.">(info)</span>:</label>
                        <input type="text" name="purpose" class="form-control" required
                            placeholder="Enter a unique name for the run">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="args">
                        Python call's argument string
                        <span class="tooltip-text" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="Enter the string that follows python -m. It can contain only alphanumeric chars and &quot;-&#039;_\^/(,)[.]">(info)</span>:
                    </label>
                    <input type="text" name="args" class="form-control" value="{{ prg_to_run.def_args }}" required>
                </div>
                <div class="accordion mb-3" id="runInputAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseOne">
                                Input files in 1 go - masterinput
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#runInputAccordion">
                            <div class="accordion-body">
                                <p> Upload all the files and optionally even more by sending a zip file
                                    that contains all the files and a MasterInput.cfg for the mapping.
                                    Inputs in the 1-by-1 tab are ignored if you select a file here.
                                    Inheritable files are all inherited if not defined
                                    in the MasterInput.cfg in the zip file.
                                </p>
                                <div class="mb-3 row">
                                    <label for="masterinput" class="col-sm-2 col-form-label">Masterinput:</label>
                                    <div class="col-sm-6">
                                        <input type="file" class="form-control" id="masterinput" name="masterinput">
                                    </div>
                                    <div class="col-sm-4 col-form-label">
                                        <a href="{{ url_for('get_template', program_name=program_name) }}">
                                            Get the MasterInput.cfg template
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseTwo">
                                Input files 1-by-1
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse show"
                            data-bs-parent="#runInputAccordion">
                            <div class="accordion-body">
                                <p>Upload files defined in the masterconfig or inherit them
                                    from the uploaded package.
                                    These files are neglected if you choose to upload the masterinput file
                                    in the previous tab.
                                    If no file is uploaded or inherited, the option is kept in
                                    the config file, but its value is set to None.
                                </p>
                                {% set inputs = prg_to_run.inputs|parse_json %}
                                {% for input_name, input_path in inputs.items() %}
                                {% if input_path is not none %}
                                <div class="mb-3 row">
                                    <label for="{{ input_name }}" class="col-sm-2 col-form-label">{{ input_name
                                        }}:</label>
                                    <div class="col-sm-6">
                                        <input type="file" class="form-control" id="{{ input_name }}" disabled
                                            name="{{ input_name }}">
                                    </div>
                                    <div class="col-form-label col-sm-4">
                                        <input class="form-check-input" type="checkbox" name="check{{ input_name }}"
                                            id="check{{ input_name }}" checked>
                                        <label class="form-check-label" for="check{{ input_name }}">Inherit
                                            <a
                                                href="{{ url_for('get_program_input', program_name=program_name, input_value=input_path) }}">{{input_path}}</a></label>
                                    </div>
                                </div>
                                {% else %}
                                <div class="mb-3 row">
                                    <label for="{{ input_name }}" class="col-sm-2 col-form-label">{{ input_name
                                        }}:</label>
                                    <div class="col-sm-6">
                                        <input type="file" class="form-control" id="{{ input_name }}"
                                            name="{{ input_name }}">
                                    </div>
                                    <div class="col-sm-4 col-form-label"><small>Not found in package</small></div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                </fieldset>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="notifications">
                        Comment:
                    </label>
                    <input type="text" name="comment" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="notifications">
                        Notify in email:
                    </label>
                    <input type="text" name="notifications" class="form-control" id="emailInput"
                        placeholder="developer_ID@company.com, manager@company.com">
                </div>
                <button type="submit" class="btn btn-primary" id="submitButton" disabled>Start run</button>
            </form>
        </div>

    </div>
    {% endif %}


    <div class="container my-4">
        <div class="row mb-2">
            <div class="col">
                {% if program_name is not none %}Program Name{% else %}
                <a
                    href="{{ url_for('runs', column='program_name', program_name=program_name, direction='desc' if direction == 'asc' and column == 'program_name' else 'asc') }}">
                    Program Name
                    {{'↑' if direction == 'asc' and column == 'program_name'}}
                    {{'↓' if direction == 'desc' and column == 'program_name'}}
                </a>
                {% endif %}
            </div>
            <div class="col">
                <a
                    href="{{ url_for('runs', column='purpose', program_name=program_name, direction='desc' if direction == 'asc' and column == 'purpose' else 'asc') }}">
                    Purpose
                    {{'↑' if direction == 'asc' and column == 'purpose'}}
                    {{'↓' if direction == 'desc' and column == 'purpose'}}
                </a>
            </div>
            <div class="col">
                <a
                    href="{{ url_for('runs', column='setup_date', program_name=program_name, direction='desc' if direction == 'asc' and column == 'setup_date' else 'asc') }}">
                    Start Date
                    {{'↑' if direction == 'asc' and column == 'setup_date'}}
                    {{'↓' if direction == 'desc' and column == 'setup_date'}}
                </a>
            </div>
            <div class="col">
                <a
                    href="{{ url_for('runs', column='status', program_name=program_name, direction='desc' if direction == 'asc' and column == 'status' else 'asc') }}">
                    Status
                    {{'↑' if direction == 'asc' and column == 'status'}}
                    {{'↓' if direction == 'desc' and column == 'status'}}
                </a>
            </div>
            <div class="col">Actions</div>
        </div>
        {% for run in runs.itertuples() %}
        <div class="row">
            <div class="col">{{ run.program_name}}</div>
            <div class="col">{{ run.purpose }}</div>
            <div class="col">{{ run.setup_date }}</div>
            <div class="col">
                {% if "Completed" in run.status %}
                <a
                    href="{{ url_for('get_run_file', program_name=run.program_name, purpose=run.purpose, file=run.program_name + '__' + run.purpose + '.zip') }}">{{
                    run.status }}</a>
                {% else %}
                {{ run.status }}{% if run.status=="running" %}, PID={{ run.pid }}{% endif %}{% endif %}
            </div>
            <div class="col">
                <a href="{{ url_for('run_log', program_name=run.program_name, purpose=run.purpose) }}">log</a> |
                {% if run.status == "running" %}Stop | {% endif %}
                <a href="{{ url_for('del_run', program_name=run.program_name, purpose=run.purpose) }}">Delete</a>
                |
                <a href="#" onclick="toggleRow(event,this)">Show more</a>
            </div>
        </div>
        <div class="row additional pt-0" style="display: none;">
            <hr>
            <div class="col-12"><strong>Python call:</strong>
                <code>python -m {{ run.python_args }}</code>
            </div>
            <div class="row">
                <div class="col-5"><strong>Uploaded files:</strong><br>
                    {% set uploads = run.uploaded_files|parse_json %}
                    {% if uploads == {} %}<span class='text-muted'>(None)</span>
                    {% else %}
                    {% for input_name, input_value in uploads.items() %}
                    {{ input_name }}: {% if input_value is not none %}
                    <a
                        href="{{ url_for('get_run_file', program_name=run.program_name, purpose=run.purpose, file=input_value) }}">
                        {{ input_value }}</a>
                    <br>
                    {% else %}
                    <span class='text-muted'>(None)</span>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
                <div class="col-5"><strong>Inherited files:</strong><br>
                    {% set inherits = run.inherited_files|parse_json %}
                    {% if inherits == {} %}<span class='text-muted'>(None)</span>
                    {% else %}
                    {% for input_name, input_value in inherits.items() %}
                    {{ input_name }}: {% if input_value is not none %}<a
                        href="{{ url_for('get_run_file', program_name=run.program_name, purpose=run.purpose, file=input_value) }}">
                        {{ input_value }}</a>
                    <br>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
                <div class="col-2"><strong>Undefined files:</strong><br>
                    {% set undefineds = run.undefineds|parse_json %}
                    {% if undefineds == [] %}<span class='text-muted'>(None)</span>
                    {% else %}
                    {% for undefined in undefineds %}
                    {{ undefined }}
                    <br>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
            <hr class="my-3 text-center border-secondary">
            <div class="col-12"><strong>Expected output files</strong>
                <a
                    href="{{ url_for('get_run_file', program_name=run.program_name, purpose=run.purpose, file=run.program_name + '__' + run.purpose) }}">(zipped
                    run folder)</a>:
                <br>
                {% set outputs = run.outputs|parse_json %}
                {% if outputs == {} %}<span class='text-muted'>(None)</span>
                {% else %}
                {% for output_name, output_path in outputs.items() %}
                {{ output_name }}: <a
                    href="{{ url_for('get_run_file', program_name=run.program_name, purpose=run.purpose, file=output_path) }}">{{output_path}}</a><br>
                {% endfor %}
                {% endif %}
            </div>


            <div class="col-12"><strong>Comment:</strong>
                {% if run.comment == "" %}<span class='text-muted'>(None)</span>
                {% else %}
                {{ run.comment }}
                {% endif %}
            </div>
            <div class="col-12"><strong>Notifications:</strong>
                {% if run.notifications == "[]" %}<span class='text-muted'>(None)</span>
                {% else %}
                {% set notifications = run.notifications|parse_json %}
                {{ notifications|join(", ")}}
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% if runs.empty %}
    No runs {% if program_name is not none%}with program name {{ program_name }}{% endif %}
    {% endif %}
</div>

{% if program_name is not none %}
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Validation Error</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Invalid email(s) entered.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

{% endif %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Handle checkbox toggles for all inputs
        {% if prg_to_run is not none %}
        {% set inputs = prg_to_run.inputs | parse_json %}
        {% for input_name, input_path in inputs.items() %}
        {% if input_path is not none %}
        document.getElementById('check{{ input_name }}').addEventListener('change', function () {
            handleCheckboxToggle('{{ input_name }}', 'check{{ input_name }}');
        });
        {% endif %}
        {% endfor %}
        {% endif %}

        function handleCheckboxToggle(inputId, checkId) {
            const input = document.getElementById(inputId);
            const checkbox = document.getElementById(checkId);

            if (checkbox.checked) {
                input.value = ''; // Clear the file input
                input.setAttribute('disabled', true); // Disable the file input
            } else {
                input.removeAttribute('disabled'); // Enable the file input
            }
        }
    });
</script>
{% endblock %}