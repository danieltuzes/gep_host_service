{% extends "base.html" %}
{% block header %}
<title>{{ service_name }} programs</title>
{% endblock header %}
{% block content %}
<div class="container mt-3">
    <h2>Programs</h2>
    <p>
        Programs are installed into their own conda environment, and their setup from their root is executed.
        <br>
        A MasterConfig.cfg from config folder with sections inputs and outputs defines the files used and generated by
        the program.
    </p>
    <!-- Install a new program collapsible -->
    <div class="accordion mb-3 shadow" id="installProgramAccordion">
        <div class="accordion-item">
            <h5 class="accordion-header border-primary border" id="headingOne">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseOne">Install a new program</button>
            </h5>
            <div id="collapseOne" class="accordion-collapse collapse">
                <div class="accordion-body" id="programSourceAccordion">
                    <form action='{{ url_for("main_routes.program_install") }}' method="post"
                        enctype="multipart/form-data">
                        <div class="mb-1">Source of the program</div>
                        <div class="row align-items-top mb-3">
                            <div class="col-2">
                                <!-- Radio Buttons -->
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="sourceType" id="zipFile"
                                        value="zip" checked>
                                    <label class="form-check-label" for="zipFile">Zip File</label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="sourceType" id="gitSource"
                                        value="git">
                                    <label class="form-check-label" for="gitSource">Git Link</label>
                                </div>
                            </div>
                            <div class="col-10">
                                <!-- Zip File Form Fields (Initially Displayed) -->
                                <div id="zipFileFields">
                                    <label for="program_package" class="form-label">
                                        Zipped Package<span style="color: red;">*</span>
                                    </label>
                                    <input type="file" name="program_package" class="form-control">
                                </div>
                                <!-- Git Source Form Fields (Initially Hidden) -->
                                <div id="gitSourceFields" style="display: none;">
                                    <div class="row">
                                        <div class="col-8">
                                            <label for="git-source-url" class="form-label">
                                                Git URL<span style="color: red;">*</span>
                                            </label>
                                            <input type="text" class="form-control" id="git-source-url"
                                                placeholder="{{ git_example }}" name="git-source-url">
                                        </div>
                                        <div class="col-4">
                                            <label for="git-source-ref" class="form-label">
                                                Branch, commit hash or
                                                tag<span style="color: red;">*</span>
                                            </label>
                                            <input type="text" class="form-control" id="git-source-ref"
                                                placeholder="{{ git_branch }}" name="git-source-ref">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="mb-3 col-md-6">
                                <label for="unique_program_name" class="form-label">
                                    Program Name <span class="tooltip-text" data-bs-toggle="tooltip"
                                        data-bs-placement="top"
                                        title="It can contain only alphanumeric chars and _.- Space and double underscore are not allowed.">(info)<span
                                            style="color: red;">*</span></span>
                                </label>
                                <input type="text" name="unique_program_name" class="form-control" required
                                    placeholder="My_Unique_Program-Name_v1.0.0">
                            </div>
                            <div class="mb-3 col-md-6">
                                <label for="required_python_version" class="form-label">
                                    Required Python Version<span style="color: red;">*</span>
                                </label>
                                <input type="text" name="required_python_version" class="form-control" required
                                    placeholder="explicit single value, e.g. 3.8">
                            </div>
                        </div>
                        <div class="row">
                            <div class="mb-3 col-md-6">
                                <label for="def_args" class="form-label">
                                    Python call's default argument string
                                    <span class="tooltip-text" data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Enter the string that follows python. It can contain only alphanumeric chars and &quot;-&#039;_\^/(,)[.]">(info)</span>
                                </label>
                                <textarea name="def_args" class="form-control mb-2" placeholder="-m my_module"
                                    rows="2"></textarea>

                                <label for="testing" class="form-label text-end">Testing:</label>
                                <select class="form-select input-selector" id="exe_test" name="exe_test">
                                    <option value="" selected>Do not run test</option>
                                    <option value="-m pytest">pytest</option>
                                    <option value="-m pytest -n auto"><code>pytest-xdist (-n auto)</code></option>
                                </select>
                            </div>
                            <div class="mb-3 col-md-6">
                                {% if libs|length > 0 %}
                                <label for="selected_libs" class="form-label">
                                    Libraries needed to run this program
                                    (multiple selection)
                                </label>
                                <select multiple class="form-select" id="selected_libs" size="5" name="selected_libs">
                                    {% for lib_name in libs['library_name'] %}<option>{{ lib_name }}</option>{% endfor
                                    %}
                                </select>
                                {% else %}
                                <label for="selected_libs" class="form-label">
                                    <span class="text-muted">Libraries needed to run this program
                                        (<a href='{{ url_for("main_routes.libraries") }}'>install a library</a> first to
                                        select one)</span>
                                </label>
                                <select multiple class="form-select" id="selected_libs" size="5" name="selected_libs"
                                    disabled>
                                </select>
                                {% endif %}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="submitButton">Install</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- installed programs -->
    <div class="container my-4">
        <div class="row mb-2">
            <div class="col-6">
                <a
                    href="{{ url_for('main_routes.programs', column='program_name', direction='desc' if direction == 'asc' and column == 'program_name' else 'asc') }}">
                    Program Name
                    {{'↑' if direction == 'asc' and column == 'program_name'}}
                    {{'↓' if direction == 'desc' and column == 'program_name'}}
                </a>
            </div>
            <div class="col-3">
                <a
                    href="{{ url_for('main_routes.programs', column='upload_date', direction='desc' if direction == 'asc' and column == 'upload_date' else 'asc') }}">
                    Install Date
                    {{'↑' if direction == 'asc' and column == 'upload_date'}}
                    {{'↓' if direction == 'desc' and column == 'upload_date'}}
                </a>
            </div>
            <div class="col-3 text-end">Actions</div>
        </div>
        {% for program in programs.itertuples() %}
        <div class="row toggle-row" id="{{ program.program_name | name_to_html_id(True) }}">
            <div class="col-6">
                <span data-bs-toggle="tooltip" data-bs-placement="top" title="{{ program.status }}">
                    {% if program.status == "Installed" %}
                    <span class="badge rounded-pill bg-success">✓</span>
                    {% elif "error" in program.status %}
                    <span class="badge rounded-pill bg-danger">X</span>
                    {% else %}
                    <span class="badge rounded-pill bg-info">↺</span>
                    {% endif %}
                </span>
                {{ program.program_name }}
            </div>
            <div class="col-3">{{ program.upload_date }}</div>
            <div class="col-3 text-end">

                <div class="btn-group">
                    {% if program.source.startswith("http") %}
                    {% set git_list = program.source.split(" ") %}
                    <a href="{{ git_list[0] }}" class="btn btn-secondary btn-sm ms-1 mb-1"
                        title="Link to the repo">🔗</a>
                    {% else %}
                    {% if program.status == "Installed" and not program.readme == "" %}
                    <a href="{{ url_for('main_routes.get_program_readme', program_name=program.program_name)}}"
                        class="btn btn-info btn-sm ms-1 mb-1" title="Open README"><i class="bi bi-info-circle"></i></a>
                    {% else %}
                    <button disabled class="btn btn-info btn-sm ms-1 mb-1"
                        title="Program is being installed or README is not found"><i
                            class="bi bi-info-circle"></i></button>
                    {% endif %}
                    {% endif %}

                    <a href="{{ url_for('main_routes.get_prg', program_name=program.program_name) }}"
                        class="btn btn-primary btn-sm me-1 mb-1" title="Download the whole package"><i
                            class="bi bi-download"></i></a>
                </div>
                {% if program.status == "Installed" %}
                <a href="{{ url_for('main_routes.runs', program_name=program.program_name) }}"
                    class="btn btn-success btn-sm me-1 mb-1" title="Setup and run on the server">
                    <i class="bi bi-play"></i></a>
                {% else %}
                <button class="btn btn-success btn-sm me-1 mb-1"
                    title="Run can be triggered after installation is complete" disabled>
                    <i class="bi bi-play"></i></button>
                {% endif %}
                <button class="btn btn-secondary btn-sm me-1 mb-1 copy-id-link"
                    title="Copy the deeplink to this element">
                    <i class="bi bi-clipboard"></i>
                </button>
            </div>
        </div>
        <div class="row additional pt-0" style="display: none;">
            <hr>
            <div class="my-3">
                <strong>Modules and version:</strong>
                {{ program.version }}<br>
                <strong>Python Version, Libs:</strong>
                {{ program.python_version }},
                {% if program.selected_libs == "" %}<span class="text-muted">(None)</span>{% else %}
                {{ program.selected_libs }}
                {% endif %}<br>
                <strong>Program status:</strong>
                {{ program.status }}
                <a href="{{ url_for('main_routes.install_log', program_name=program.program_name) }}">Download the
                    install log
                    file</a>
            </div>
            <div class="my-3">
                <strong>Inputs:</strong>
                <br>
                {% set inputs = program.inputs|parse_json %}
                {% for input_name, input_value in inputs.items() %}
                {{ input_name }}:
                {% if input_value is not none %}
                <!-- TODO this is needed to show inherited package -->
                <a
                    href="{{ url_for('main_routes.get_program_input', program_name=program.program_name, input_path=input_value) }}">
                    {{ input_value }}
                </a>
                {% else %}
                <span class="text-muted">(not present in the package)</span>
                {% endif %}
                <br>
                {% endfor %}
            </div>
            <div class="my-3">
                <strong>Outputs:</strong>
                <br>
                {% set outputs = program.outputs|parse_json %}
                {% for output_name, output_value in outputs.items() %}
                {{ output_name }}: {{ output_value }}
                <br>
                {% endfor %}
            </div>
            <div class="my-3">
                <strong>Default call:</strong>
                <code>python {{ program.def_args }}
                            {% if program.def_args == "" %}<span class="text-muted">(no default arguments)</span>{% endif %}
                        </code>
            </div>
            <div class="my-3">
                <strong>Program source:</strong> {{ program.source }}
            </div>
            <div class="my-2">
                <span data-bs-toggle="tooltip" data-bs-placement="top"
                    title="Deleting the program does not delete its runs, nor the libraries linked to it.">
                    <a href="{{ url_for('main_routes.del_program', program_name=program.program_name) }}"
                        class="btn btn-danger btn-sm"><i class="bi bi-trash me-2"></i>Delete</a>
                </span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // switch between file upload and git source
        let zipRadioButton = document.getElementById('zipFile');
        let gitRadioButton = document.getElementById('gitSource');
        let zipFileFields = document.getElementById('zipFileFields');
        let gitSourceFields = document.getElementById('gitSourceFields');
        let zipFileInput = document.querySelector('[name="program_package"]');
        let gitUrlInput = document.querySelector('[name="git-source-url"]');
        let gitRefInput = document.querySelector('[name="git-source-ref"]');
        let installForm = document.querySelector('form');

        // Function to toggle display and required attributes
        function toggleFields() {
            if (zipRadioButton.checked) {
                zipFileFields.style.display = 'block';
                gitSourceFields.style.display = 'none';
                zipFileInput.required = true;
                gitUrlInput.required = false;
                gitRefInput.required = false;
            } else {
                zipFileFields.style.display = 'none';
                gitSourceFields.style.display = 'block';
                zipFileInput.required = false;
                gitUrlInput.required = true;
                gitRefInput.required = true;
            }
        }

        // Initial toggle on page load
        toggleFields();

        // Event listeners for radio buttons
        zipRadioButton.addEventListener('change', toggleFields);
        gitRadioButton.addEventListener('change', toggleFields);
    });
</script>
{% endblock %}